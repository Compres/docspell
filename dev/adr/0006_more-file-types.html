<!DOCTYPE html><html><head><title>Docspell: More File Types</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="eikek" /><meta name="description" content="Auto-tagging Document Organizer" /><meta name="og:image" content="/docspell/img/poster.png" /><meta name="image" property="og:image" content="/docspell/img/poster.png" /><meta name="og:title" content="Docspell: More File Types" /><meta name="title" property="og:title" content="Docspell: More File Types" /><meta name="og:site_name" content="Docspell" /><meta name="og:url" content="" /><meta name="og:type" content="website" /><meta name="og:description" content="Auto-tagging Document Organizer" /><link rel="icon" type="image/png" href="/docspell/img/favicon.png" /><meta name="twitter:title" content="Docspell: More File Types" /><meta name="twitter:image" content="/docspell/img/poster.png" /><meta name="twitter:description" content="Auto-tagging Document Organizer" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="96x96" href="/docspell/img/favicon.png" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/docspell/highlight/styles/vs.css" /><link rel="stylesheet" href="/docspell/css/light-style.css" /><link rel="stylesheet" href="/docspell/css/docspell.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><div id="sidebar-brand"><a href="/docspell/" class="brand"><div class="brand-wrapper"></div><span>Docspell</span></a><button id="main-toggle" class="sidebar-toggle"><span class="close"></span></button></div><div class="sidebar-nav"> <div class="sidebar-nav-item  "><a href="/docspell/index.html" title="Home" class="">Home</a></div> <div class="sidebar-nav-item  "><a href="/docspell/demo.html" title="Demo" class="">Demo</a></div> <div class="sidebar-nav-item  "><a href="/docspell/getit" title="Quickstart" class="">Quickstart</a></div> <div class="sidebar-nav-item  "><a href="/docspell/features.html" title="Features/Limitations" class="">Features/Limitations</a></div> <div class="sidebar-nav-item  "><a href="/docspell/doc.html" title="Documentation" class="drop-nested">Documentation</a><i class="fa fa-angle-right"></i><div class="sub-section"> <a href="/docspell/doc/install.html" title="Installation" class="">Installation</a> <a href="/docspell/doc/configure.html" title="Configuring" class="">Configuring</a> <a href="/docspell/doc/nix" title="Nix/NixOS" class="">Nix/NixOS</a> <a href="/docspell/doc/reverseproxy" title="Reverse Proxy" class="">Reverse Proxy</a> <a href="/docspell/doc/metadata.html" title="Adding Meta Data" class="">Adding Meta Data</a> <a href="/docspell/doc/uploading.html" title="Uploads" class="">Uploads</a> <a href="/docspell/doc/processing.html" title="Processing Queue" class="">Processing Queue</a> <a href="/docspell/doc/curate.html" title="Find and Review" class="">Find and Review</a> <a href="/docspell/doc/mailitem.html" title="Send via E-Mail" class="">Send via E-Mail</a> <a href="/docspell/doc/joex.html" title="Joex" class="">Joex</a> <a href="/docspell/doc/tools.html" title="Tools" class="">Tools</a></div></div> <div class="sidebar-nav-item  "><a href="/docspell/changelog" title="Changelog" class="">Changelog</a></div> <div class="sidebar-nav-item  "><a href="/docspell/dev.html" title="Development" class="drop-nested">Development</a><i class="fa fa-angle-right"></i><div class="sub-section"> <a href="/docspell/dev/adr.html" title="" class=""></a></div></div> <div class="sidebar-nav-item  "><a href="/docspell/api.html" title="Api" class="drop-nested">Api</a><i class="fa fa-angle-right"></i><div class="sub-section"> <a href="/docspell/openapi/docspell-openapi.html" title="REST Api Doc" class="">REST Api Doc</a> <a href="/docspell/openapi/docspell-openapi.yml" title="REST OpenApi Spec" class="">REST OpenApi Spec</a></div></div></div></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/eikek/docspell" target="_blank" rel="noopener noreferrer"><i class="fa fa-eye"></i><span>Watchers<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/eikek/docspell" target="_blank" rel="noopener noreferrer"><i class="fa fa-star-o"></i><span>Stars<span id="stars" class="label label-default">--</span></span></a></li></ul></div></div></div></div><div id="content" data-github-owner="eikek" data-github-repo="docspell"><div class="content-wrapper"><section><h1 id="more-file-types">More File Types</h1>

<h2 id="context-and-problem-statement">Context and Problem Statement</h2>

<p>Docspell currently only supports PDF files. This has simplified early
development and design a lot and so helped with starting the project.
Handling pdf files is usually easy (to view, to extract text, print
etc).</p>

<p>The pdf format has been chosen, because PDFs files are very common and
can be viewed with many tools on many systems (i.e. non-proprietary
tools). Docspell also is a document archive and from this perspective,
it is important that documents can be viewed in 10 years and more. The
hope is, that the PDF format is best suited for this. Therefore all
documents in Docspell must be accessible as PDF. The trivial solution
to this requirement is to only allow PDF files.</p>

<p>Support for more document types, must then take care of the following:</p>

<ul>
  <li>extracting text</li>
  <li>converting into pdf</li>
  <li>access original file</li>
</ul>

<p>Text should be extracted from the source file, in case conversion is
not lossless. Since Docspell can already extract text from PDF files
using OCR, text can also be extracted from the converted file as a
fallback.</p>

<p>The original file must always be accessible. The main reason is that
all uploaded data should be accessible without any modification. And
since the conversion may not always create best results, the original
file should be kept.</p>

<h2 id="decision-drivers">Decision Drivers</h2>

<p>People expect that software like Docspell support the most common
document types, like all the “office documents” (<code class="highlighter-rouge">docx</code>, <code class="highlighter-rouge">rtf</code>, <code class="highlighter-rouge">odt</code>,
<code class="highlighter-rouge">xlsx</code>, …) and images. For many people it is more common to create
those files instead of PDF. Some (older) scanners may not be able to
scan into PDF files but only to image files.</p>

<h2 id="considered-options">Considered Options</h2>

<p>This ADR does not evaluate different options. It rather documents why
this feature is realized and the thoughts that lead to how it is
implemented.</p>

<h2 id="realization">Realization</h2>

<h3 id="data-model">Data Model</h3>

<p>The <code class="highlighter-rouge">attachment</code> table holds one file. There will be another table
<code class="highlighter-rouge">attachment_source</code> that holds the original file. It looks like this:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">"attachment_source"</span> <span class="p">(</span>
  <span class="nv">"id"</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">254</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
  <span class="nv">"file_id"</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">254</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
  <span class="nv">"filename"</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">254</span><span class="p">),</span>
  <span class="nv">"created"</span> <span class="nb">timestamp</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
  <span class="k">foreign</span> <span class="k">key</span> <span class="p">(</span><span class="nv">"file_id"</span><span class="p">)</span> <span class="k">references</span> <span class="nv">"filemeta"</span><span class="p">(</span><span class="nv">"id"</span><span class="p">),</span>
  <span class="k">foreign</span> <span class="k">key</span> <span class="p">(</span><span class="nv">"id"</span><span class="p">)</span> <span class="k">references</span> <span class="nv">"attachment"</span><span class="p">(</span><span class="nv">"attachid"</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div></div>

<p>The <code class="highlighter-rouge">id</code> is the primary key and is the same as the associated
<code class="highlighter-rouge">attachment</code>, creating a <code class="highlighter-rouge">1-1</code> relationship (well, more correct is
<code class="highlighter-rouge">0..1-1</code>) between <code class="highlighter-rouge">attachment</code> and <code class="highlighter-rouge">attachment_source</code>.</p>

<p>There will always be a <code class="highlighter-rouge">attachment_source</code> record for every
<code class="highlighter-rouge">attachment</code> record. If the original file is a PDF already, then both
table’s <code class="highlighter-rouge">file_id</code> columns point to the same file. But now the user can
change the filename of an <code class="highlighter-rouge">attachment</code> while the original filename is
preserved in <code class="highlighter-rouge">attachment_source</code>. It must not be possible for the user
to change anything in <code class="highlighter-rouge">attachment_source</code>.</p>

<p>The <code class="highlighter-rouge">attachment</code> table is not touched in order to keep current code
mostly unchanged and to have a simpler data migration. The downside
is, that the data model allows to have an <code class="highlighter-rouge">attachment</code> record without
an <code class="highlighter-rouge">attachment_source</code> record. OTOH, a foreign key inside <code class="highlighter-rouge">attachment</code>
pointing to an <code class="highlighter-rouge">attachment_source</code> is also not correct, because it
allows the same <code class="highlighter-rouge">attachment_source</code> record to be associated with many
<code class="highlighter-rouge">attachment</code> records. This would do even more harm, in my opinion.</p>

<h3 id="migration">Migration</h3>

<p>Creating a new table and not altering existing ones, should simplify
data migration.</p>

<p>Since only PDF files where allowed and the user could not change
anything in the <code class="highlighter-rouge">attachment</code> table, the existing data can simply be
inserted into the new table. This presents the trivial case where the
attachment and source are the same.</p>

<h3 id="processing">Processing</h3>

<p>The first step in processing is now converting the file into a pdf. If
it already is a pdf, nothing is done. This step is before text
extraction, so text can first be tried to extract from the source file
and only if that fails (or is not supported), text can be extracted
from the converted pdf file. All remaining steps are untouched.</p>

<p>If conversion is not supported for the input file, it is skipped. If
conversion fails, the error is propagated to let the retry mechanism
take care.</p>

<h4 id="what-types">What types?</h4>

<p>Which file types should be supported? At a first step, all major
office documents, common images, plain text (i.e. markdown) and html
should be supported. In terms of file extensions: <code class="highlighter-rouge">doc</code>, <code class="highlighter-rouge">docx</code>,
<code class="highlighter-rouge">xls</code>, <code class="highlighter-rouge">xlsx</code>, <code class="highlighter-rouge">odt</code>, <code class="highlighter-rouge">md</code>, <code class="highlighter-rouge">html</code>, <code class="highlighter-rouge">txt</code>, <code class="highlighter-rouge">jpg</code>, <code class="highlighter-rouge">png</code>, <code class="highlighter-rouge">tif</code>.</p>

<p>There is always the preference to use jvm internal libraries in order
to be more platform independent and to reduce external dependencies.
But this is not always possible (like doing OCR).</p>

<div class="thumbnail">
  <img src="./img/process-files.png" title="Overview processing files" />
</div>

<h4 id="conversion">Conversion</h4>

<ul>
  <li>Office documents (<code class="highlighter-rouge">doc</code>, <code class="highlighter-rouge">docx</code>, <code class="highlighter-rouge">xls</code>, <code class="highlighter-rouge">xlsx</code>, <code class="highlighter-rouge">odt</code>, <code class="highlighter-rouge">ods</code>):
unoconv (see <a href="0009_convert_office_docs">ADR 9</a>)</li>
  <li>HTML (<code class="highlighter-rouge">html</code>): wkhtmltopdf (see <a href="0007_convert_html_files">ADR 7</a>)</li>
  <li>Text/Markdown (<code class="highlighter-rouge">txt</code>, <code class="highlighter-rouge">md</code>): Java-Lib flexmark + wkhtmltopdf</li>
  <li>Images (<code class="highlighter-rouge">jpg</code>, <code class="highlighter-rouge">png</code>, <code class="highlighter-rouge">tif</code>): Tesseract (see <a href="0010_convert_image_files">ADR
10</a>)</li>
</ul>

<h4 id="text-extraction">Text Extraction</h4>

<ul>
  <li>Office documents (<code class="highlighter-rouge">doc</code>, <code class="highlighter-rouge">docx</code>, <code class="highlighter-rouge">xls</code>, <code class="highlighter-rouge">xlsx</code>): Apache Poi</li>
  <li>Office documends (<code class="highlighter-rouge">odt</code>, <code class="highlighter-rouge">ods</code>): Apache Tika (including the sources)</li>
  <li>HTML: not supported, extract text from converted PDF</li>
  <li>Images (<code class="highlighter-rouge">jpg</code>, <code class="highlighter-rouge">png</code>, <code class="highlighter-rouge">tif</code>): Tesseract</li>
  <li>Text/Markdown: n.a.</li>
  <li>PDF: Apache PDFBox or Tesseract</li>
</ul>

<h2 id="links">Links</h2>

<ul>
  <li><a href="0007_convert_html_files">Convert HTML Files</a></li>
  <li><a href="0008_convert_plain_text">Convert Plain Text</a></li>
  <li><a href="0009_convert_office_docs">Convert Office Documents</a></li>
  <li><a href="0010_convert_image_files">Convert Image Files</a></li>
  <li><a href="0011_extract_text">Extract Text from Files</a></li>
</ul>
</section><div class="edit-button"><a href="https://github.com/eikek/docspell/edit/master/modules/microsite/docs/dev/adr/0006_more-file-types.md" target="_blank" rel="noopener noreferrer" class="btn-sm btn-info">Improve this page</a></div></div></div></div></div><script src="/docspell/highlight/highlight.pack.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/json.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/javascript.min.js"></script><script>
// For all code blocks, copy the language from the containing div
// to the inner code tag (where hljs expects it to be)
const langPrefix = 'language-';
document.querySelectorAll(`div[class^='${langPrefix}']`).forEach(function(div) {
  div.classList.forEach(function(cssClass) {
    if (cssClass.startsWith(langPrefix)) {
      const lang = cssClass.substring(langPrefix.length);
      div.querySelectorAll('pre code').forEach(function(code) {
        code.classList.add(lang);
      });
    }
  });
});

hljs.configure({languages:['scala','java','bash','json','javascript']});
hljs.initHighlightingOnLoad();
      </script><script>console.info('\x57\x65\x62\x73\x69\x74\x65\x20\x62\x75\x69\x6c\x74\x20\x77\x69\x74\x68\x3a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x5f\x5f\x0a\x20\x20\x20\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x5f\x20\x20\x2f\x20\x2f\x5f\x20\x20\x20\x20\x20\x20\x5f\x5f\x5f\x5f\x20\x5f\x5f\x5f\x20\x20\x28\x5f\x29\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x28\x5f\x29\x20\x2f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x0a\x20\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x60\x5f\x5f\x20\x5c\x2f\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x20\x2f\x20\x5f\x5f\x2f\x20\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x0a\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x5f\x2f\x20\x2f\x20\x2f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x5f\x5f\x2f\x20\x2f\x20\x20\x2f\x20\x2f\x5f\x2f\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x20\x2f\x5f\x2f\x20\x20\x5f\x5f\x28\x5f\x5f\x20\x20\x29\x0a\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2e\x5f\x5f\x5f\x2f\x5c\x5f\x5f\x2f\x20\x20\x20\x20\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x2f\x20\x20\x20\x5c\x5f\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x0a\x0a\x68\x74\x74\x70\x73\x3a\x2f\x2f\x34\x37\x64\x65\x67\x2e\x67\x69\x74\x68\x75\x62\x2e\x69\x6f\x2f\x73\x62\x74\x2d\x6d\x69\x63\x72\x6f\x73\x69\x74\x65\x73')</script><script src="/docspell/js/docs.js"></script></body></html>